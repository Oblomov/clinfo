
!IFNDEF PLATFORM
PLATFORM=$(VSCMD_ARG_TGT_ARCH)
!ENDIF

# TODO FIXME find a better way to detect the directory to use
# for OpenCL development files
!IF ("$(OPENCLDIR)" == "") && EXIST("$(VCPKG_ROOT)\installed\$(PLATFORM)-windows\include\CL\cl.h")
OPENCLDIR = $(VCPKG_ROOT)\installed\$(PLATFORM)-windows
LIBS = OpenCL.lib
LIBPATH32 = /LIBPATH:"$(OPENCLDIR)\lib"
LIBPATH64 = /LIBPATH:"$(OPENCLDIR)\lib"
!ENDIF
!IF "$(OPENCLDIR)" == ""
OPENCLDIR = $(INTELOCLSDKROOT)
LIBS = OpenCL.lib
LIBPATH32 = /LIBPATH:"$(OPENCLDIR)\lib\x86"
LIBPATH64 = /LIBPATH:"$(OPENCLDIR)\lib\x64"
!ENDIF
!IF "$(OPENCLDIR)" == ""
OPENCLDIR = $(AMDAPPSDKROOT)
LIBS = libopenCL.a
LIBPATH32 = /LIBPATH:"$(OPENCLDIR)\lib\x86"
LIBPATH64 = /LIBPATH:"$(OPENCLDIR)\lib\x86_64"
!ENDIF
!IF "$(OPENCLDIR)" == ""
OPENCLDIR = $(MAKEDIR)
LIBS = libopenCL.a
LIBPATH32 = /LIBPATH:"$(OPENCLDIR)\lib" /LIBPATH:"$(OPENCLDIR)\lib\x86"
LIBPATH64 = /LIBPATH:"$(OPENCLDIR)\lib\x64" /LIBPATH:"$(OPENCLDIR)\lib\x86_64" /LIBPATH:"$(OPENCLDIR)\lib\x86_amd64"
!ENDIF
!IF "$(OPENCLDIR)" == ""
OPENCLDIR = .
LIBS = libopenCL.a
LIBPATH32 = /LIBPATH:"$(OPENCLDIR)\lib" /LIBPATH:"$(OPENCLDIR)\lib\x86"
LIBPATH64 = /LIBPATH:"$(OPENCLDIR)\lib\x64" /LIBPATH:"$(OPENCLDIR)\lib\x86_64" /LIBPATH:"$(OPENCLDIR)\lib\x86_amd64"
!ENDIF
!MESSAGE OpenCL dir: $(OPENCLDIR)

HDR =	src/error.h \
	src/ext.h \
	src/ctx_prop.h \
	src/fmtmacros.h \
	src/memory.h \
	src/ms_support.h \
	src/info_loc.h \
	src/info_ret.h \
	src/opt_out.h \
	src/strbuf.h

CFLAGS = /GL /Ox /W4 /Zi /I"$(OPENCLDIR)\include" /nologo

# TODO there's most likely a better way to do the multiarch
# switching
!IF "$(PROCESSOR_ARCHITECTURE)" == "AMD64"
ARCH=64
!ELSE
ARCH=32
!ENDIF

# Platform=x64 in the 64-bit cross-platform build of my VS
!IF "$(PLATFORM)" == "x64" || "$(PLATFORM)" == "X64"
ARCH=64
!ELSE IF "$(PLATFORM)" == "x86" || "$(PLATFORM)" == "X86"
ARCH=32
!ENDIF

!MESSAGE Building for $(ARCH)-bit (processor architecture: $(PROCESSOR_ARCHITECTURE), platform: $(PLATFORM))

# And since we can't do $(LIBPATH$(ARCH)) with nmake ...
!IF "$(ARCH)" == "64"
LINKOPTS = /LTCG $(LIBPATH64) /nologo
!ELSE
LINKOPTS = /LTCG $(LIBPATH32) /nologo
!ENDIF

clinfo.exe: clinfo.obj
	link $(LINKOPTS) $(LIBS) clinfo.obj /out:clinfo.exe

clinfo.obj: src/clinfo.c $(HDR)
	$(CC) $(CFLAGS) /c src/clinfo.c /Foclinfo.obj

clean:
	del /F /Q clinfo.exe clinfo.obj

.PHONY: clean

